{"version":3,"sources":["../../../../../../../assets/mahjong/script/ui/prefab/assets/mahjong/script/ui/prefab/mjVotingPopUI.js"],"names":["mjDataMgr","require","mjNetMgr","cc","Class","extends","Component","properties","btnAgree","type","Node","default","btnDisagree","playerList","timeLabel","Label","titleLabel","RichText","onLoad","string","children","forEach","value","active","_selfUserId","fun","db","getData","UserId","_playerNodes","_playersData","getInstance","getAllPlayersData","index","idx","id","imgNode","getChildByName","utils","loadUrlRes","Icon","showVoteChoice","getComponent","showName","animation","node","Animation","clips","getClips","on","onBtnAgreeClick","onBtnDisagreeClick","_currTime","Math","floor","Date","now","net","pSend","rsp","Now","bind","sumdt","updateData","data","_endTime","EndTime","k","VoteInfo","onEnable","play","name","update","dt","showTime","parseInt","code","log","disbandRoomVoted","RetCode","getIns","disbandRoomVote","OP","close","once","destroy"],"mappings":"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","file":"mjVotingPopUI.js","sourceRoot":"../../../../../../../assets/mahjong/script/ui/prefab","sourcesContent":["const mjDataMgr = require(\"mjDataMgr\");\nconst mjNetMgr  = require(\"mjNetMgr\");\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        btnAgree: {\n            type: cc.Node,\n            default: null,\n        },\n\n        btnDisagree: {\n            type: cc.Node,\n            default: null,\n        },\n\n        playerList: {\n            type: cc.Node,\n            default: null,\n        },\n\n        timeLabel: {\n            type: cc.Label,\n            default: null,\n        },\n\n        titleLabel: {\n            type: cc.RichText,\n            default: null,\n        },\n    },\n\n    onLoad () {\n        this.timeLabel.string = \"\";\n        this.playerList.children.forEach(function (value) {\n            value.active = false;\n        });\n        this._selfUserId = fun.db.getData('UserInfo').UserId;\n        this._playerNodes = {};\n        this._playersData = mjDataMgr.getInstance().getAllPlayersData();\n        let index = -1;\n        for(let idx in this._playersData){\n            index += 1;\n            let value = this._playersData[idx];\n            const id = value.UserId + '';\n            this._playerNodes[id] = this.playerList.children[index];\n            this._playerNodes[id].active = true;\n            let imgNode = this._playerNodes[id].getChildByName('img');\n            fun.utils.loadUrlRes(value.Icon, imgNode, id);\n            this.showVoteChoice(id, 0);\n            this._playerNodes[id].getChildByName('name').getComponent(cc.Label).string = value.showName;\n            this._playerNodes[id].showName = value.showName;\n\n        }\n\n        this.animation = this.node.getComponent(cc.Animation);\n        this.clips = this.animation.getClips();\n\n        this.btnAgree.on('click', this.onBtnAgreeClick, this);\n        this.btnDisagree.on('click', this.onBtnDisagreeClick, this);\n\n        this._currTime = Math.floor(Date.now() / 1000);\n        fun.net.pSend('ServerTime', '', function(rsp) {\n            if (rsp.Now) {\n                this._currTime = rsp.Now;\n            }\n        }.bind(this));\n        this.sumdt = 0;\n    },\n\n    updateData (data) {\n        this._endTime = data.EndTime;\n        for (const k in data.VoteInfo) {\n            this.showVoteChoice(k, data.VoteInfo[k]);\n        }\n    },\n\n    onEnable () {\n        this.animation.play(this.clips[0].name);\n    },\n\n    update (dt) {\n        this.sumdt += dt;\n        if (this.sumdt < 1) {\n            return;\n        }\n        this._currTime += 1;\n        this.sumdt -= 1;\n        let showTime = 0;\n        if (this._endTime) {\n            showTime = this._endTime - this._currTime;\n        } else {\n            showTime = parseInt(this.timeLabel.string) -1;\n        }\n        if (showTime < 0) {\n            showTime = 0;\n        }\n        this.timeLabel.string = showTime;\n    },\n\n    showVoteChoice(UserId, code = 0) {\n        cc.log(\"---showVoteChoice------UserId:\"+UserId + \" code:\" + code, UserId == (this._selfUserId + ''));\n        //code 0:未选择 1:发起人 2:同意 3: 拒绝\n        this._playerNodes[UserId].getChildByName('ok').active = (code === 1 || code === 2);\n        this._playerNodes[UserId].getChildByName('no').active = (code === 3);\n        if (UserId == (this._selfUserId + '') && (code !== 0)) {\n            this.btnAgree.active = false;\n            this.btnDisagree.active = false;\n        }\n        if (code === 1 || code === 2) {\n            this.titleLabel.string = `玩家${this._playerNodes[UserId].showName}申请退出游戏，请投票`;\n        }\n    },\n\n    disbandRoomVoted : function(data){\n        if (data.RetCode && data.RetCode !== 0) {\n            cc.log('DisbandRoomVote------------ retcode = ', data.RetCode);\n        }\n        // this.btnAgree.active = false;\n        // this.btnDisagree.active = false;\n    },\n\n    onBtnAgreeClick () {\n        mjNetMgr.getIns().disbandRoomVote({OP:2}, this.disbandRoomVoted.bind(this));\n    },\n\n    onBtnDisagreeClick () {\n        mjNetMgr.getIns().disbandRoomVote({OP:3}, this.disbandRoomVoted.bind(this));\n    },\n\n    close () {\n        this.animation.play(this.clips[1].name).once('finished', function () {\n            this.node.destroy();\n        }, this);\n    },\n\n});\n"]}