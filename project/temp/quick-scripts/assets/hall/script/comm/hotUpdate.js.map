{"version":3,"sources":["hotUpdate.js"],"names":["GameConst","require","NeedForce","cc","Class","extends","Component","properties","manifestUrl","url","RawAsset","default","gameName","type","hall","loseFileStr","loseRemoteFileStr","foundNewStr","updateErrStr","updatePanelPrefab","Prefab","onLoad","sys","isBrowser","fun","gameCfg","enableUpdate","updatedGame","db","getData","storagePath","path","join","jsb","fileUtils","getWritablePath","atManager","AssetsManager","versionCompare","retain","getState","State","UNCHECKED","loadLocalManifest","getLocalManifest","isLoaded","showError","checkListener","EventListenerAssetsManager","checkUpdateCB","bind","eventManager","addListener","checkUpdate","hasCheckListener","versionA","versionB","va","split","vb","i","length","a","parseInt","b","event","getEventCode","EventAssetsManager","ERROR_NO_LOCAL_MANIFEST","log","ERROR_DOWNLOAD_MANIFEST","ERROR_PARSE_MANIFEST","ALREADY_UP_TO_DATE","completeUpdate","NEW_VERSION_FOUND","reqVersionDetail","removeListener","setData","updatePanel","instantiate","verUrl","getPackageUrl","xhr","XMLHttpRequest","onreadystatechange","readyState","status","forceUpdate","parent","node","getComponent","setVersionContent","responseText","startUpdate","showGetUpdateContentError","open","send","sdata","contentStr","okBtnStr","okCb","os","OS_ANDROID","openURL","gameConst","forceUpdateUrl","android","OS_IOS","ios","closeCb","utils","endGame","dispatch","removeDirectory","hasUpdateListener","updateListener","updatingCB","UNINITED","update","needRestart","UPDATE_FAILED","ERROR_UPDATING","getAssetId","getMessage","UPDATE_PROGRESSION","_getTotalBytes","getTotalBytes","console","JSON","stringify","getTotalFiles","getPercent","getPercentByFile","setSourceSize","updateProgress","UPDATE_FINISHED","searchPaths","getSearchPaths","newPaths","Array","prototype","unshift","localStorage","setItem","setSearchPaths","restart","str","data","hideCloseBtn","onDestroy","release"],"mappings":"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","file":"hotUpdate.js","sourceRoot":"../../../../../../assets/hall/script/comm","sourcesContent":["const GameConst = require(\"GameCfg\");\nlet NeedForce = false;\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        manifestUrl: {\n            url: cc.RawAsset,\n            default: null,\n        },\n\n        gameName: {\n            type: GameConst.gameName,\n            default: GameConst.gameName.hall,\n        },\n\n        loseFileStr: {\n            default: '本地文件丢失，请卸载后重新安装！',\n        },\n\n        loseRemoteFileStr: {\n            default: '下载版本文件出错，请稍后再试！',\n        },\n\n        foundNewStr: {\n            default: '发现新版本，请更新！',\n        },\n\n        updateErrStr: {\n            default: '更新出错，请重试！',\n        },\n\n        updatePanelPrefab: {\n            default: null,\n            type: cc.Prefab,\n        },\n    },\n\n    onLoad () {\n        if (cc.sys.isBrowser) {\n            return;\n        }\n        if (!fun.gameCfg.enableUpdate) {\n            return;\n        }\n        let updatedGame = fun.db.getData('UpdatedGame');\n        if (updatedGame && updatedGame[this.gameName]) {\n            return;\n        }\n\n        const storagePath = cc.path.join(jsb.fileUtils.getWritablePath(), 'hotUpdate');\n        this.atManager = new jsb.AssetsManager(this.manifestUrl, storagePath, this.versionCompare);\n        this.atManager.retain();\n        if (this.atManager.getState() === jsb.AssetsManager.State.UNCHECKED) {\n            this.atManager.loadLocalManifest(this.manifestUrl);\n        }\n        if (!this.atManager.getLocalManifest() || !this.atManager.getLocalManifest().isLoaded()) {\n            this.showError(this.loseFileStr);\n            return;\n        }\n\n        this.checkListener = new jsb.EventListenerAssetsManager(this.atManager, this.checkUpdateCB.bind(this));\n        cc.eventManager.addListener(this.checkListener, 1);\n        this.atManager.checkUpdate();\n        this.hasCheckListener = true;\n    },\n\n    versionCompare (versionA, versionB) {\n        let va = versionA.split('.'), vb = versionB.split('.');\n        NeedForce = vb[0] > va[0];\n        for (let i = 0; i < va.length; ++i) {\n            let a = parseInt(va[i]), b = parseInt(vb[i]);\n            if (a !== b) {\n                return a - b;\n            }\n        }\n        if (vb.length > va.length) {\n            return -1;\n        } else {\n            return 0;\n        }\n    },\n\n    checkUpdateCB (event) {\n        switch (event.getEventCode()) {\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\n                fun.log('hotUpdate', this.gameName + 'checkUpdateCB ERROR_NO_LOCAL_MANIFEST');\n                this.showError(this.loseFileStr);\n                break;\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\n                fun.log('hotUpdate', this.gameName + 'checkUpdateCB ERROR_DOWNLOAD_MANIFEST');\n                this.showError(this.loseRemoteFileStr);\n                break;\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\n                fun.log('hotUpdate', this.gameName + 'checkUpdateCB ERROR_PARSE_MANIFEST');\n                this.showError(this.loseRemoteFileStr);\n                break;\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\n                this.completeUpdate();\n                break;\n            case jsb.EventAssetsManager.NEW_VERSION_FOUND:\n                this.reqVersionDetail();\n                break;\n            default:\n                return;\n        }\n        if (this.hasCheckListener) {\n            cc.eventManager.removeListener(this.checkListener);\n            this.hasCheckListener = false;\n        }\n    },\n\n    completeUpdate () {\n        let updatedGame = fun.db.getData('UpdatedGame');\n        updatedGame[this.gameName] = this.gameName;\n        fun.db.setData('UpdatedGame', updatedGame);\n    },\n\n    reqVersionDetail () {\n        this.updatePanel = cc.instantiate(this.updatePanelPrefab);\n        const verUrl = this.atManager.getLocalManifest().getPackageUrl() + 'ver.txt';\n        let xhr = new XMLHttpRequest();\n        xhr.onreadystatechange = function () {\n            if (xhr.readyState === 4) {\n                if (xhr.status >= 200 && xhr.status < 400) {\n                    if (NeedForce) {\n                        this.forceUpdate();\n                    } else {\n                        this.updatePanel.parent = this.node;\n                        this.updatePanel.getComponent('updatePanel').setVersionContent(xhr.responseText.split(':::'), this.startUpdate.bind(this));\n                    }\n                } else {\n                    this.showGetUpdateContentError();\n                }\n            }\n        }.bind(this);\n        xhr.open(\"GET\", verUrl, true);\n        xhr.send();\n    },\n\n    forceUpdate () {\n        let sdata = {\n            contentStr: '您的客户端版本过低，请下载最新版本！',\n            okBtnStr: '前往下载',\n            okCb () {\n                if (cc.sys.os === cc.sys.OS_ANDROID)\n                    cc.sys.openURL(gameConst.forceUpdateUrl.android);\n                else if (cc.sys.os === cc.sys.OS_IOS)\n                    cc.sys.openURL(gameConst.forceUpdateUrl.ios);\n            },\n            closeCb () {\n                fun.utils.endGame();\n            }\n        };\n        fun.event.dispatch('MinDoubleButtonPop', sdata);\n        jsb.fileUtils.removeDirectory(cc.path.join(jsb.fileUtils.getWritablePath(), \"hotUpdate\"));\n    },\n\n    startUpdate () {\n        this.hasUpdateListener = true;\n        this.updateListener = new jsb.EventListenerAssetsManager(this.atManager, this.updatingCB.bind(this));\n        cc.eventManager.addListener(this.updateListener, 1);\n        if (this.atManager.getState() === jsb.AssetsManager.State.UNINITED) {\n            this.atManager.loadLocalManifest(this.manifestUrl);\n        }\n        this.atManager.update();\n    },\n\n    updatingCB (event) {\n        let needRestart = false;\n        switch (event.getEventCode()) {\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\n                fun.log('hotUpdate', this.gameName + 'updatingCB ERROR_NO_LOCAL_MANIFEST');\n                this.showError(this.loseFileStr);\n                break;\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\n                fun.log('hotUpdate', this.gameName + 'updatingCB ERROR_DOWNLOAD_MANIFEST');\n                this.showError(this.loseRemoteFileStr);\n                break;\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\n                fun.log('hotUpdate', this.gameName + 'updatingCB ERROR_PARSE_MANIFEST');\n                this.showError(this.loseRemoteFileStr);\n                break;\n            case jsb.EventAssetsManager.UPDATE_FAILED:\n                fun.log('hotUpdate', this.gameName + 'updatingCB UPDATE_FAILED');\n                this.showError(this.updateErrStr);\n                break;\n            case jsb.EventAssetsManager.ERROR_UPDATING:\n                fun.log('hotUpdate', `Asset update error: ${event.getAssetId()}, ${event.getMessage()}`);\n                break;\n            case jsb.EventAssetsManager.UPDATE_PROGRESSION:\n                if(!this._getTotalBytes && event.getTotalBytes() !== 0){\n                    console.log('--- event: ', event);\n                    console.log('--- event.str: ', JSON.stringify(event));\n                    console.log('--- getTotalBytes: ', event.getTotalBytes());\n                    console.log('--- getTotalFiles: ', event.getTotalFiles());\n                    console.log('--- getPercent: ', event.getPercent());\n                    console.log('--- getPercentByFile: ', event.getPercentByFile());\n                    console.log('--- getMessage: ', event.getMessage());\n                    this.updatePanel.getComponent('updatePanel').setSourceSize(event.getTotalBytes()/(1024*1024));\n                    this._getTotalBytes = true;\n                }\n\n                this.updatePanel.getComponent('updatePanel').updateProgress(event.getPercent());\n                break;\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\n                needRestart = true;\n                break;\n            case jsb.EventAssetsManager.UPDATE_FINISHED:\n                needRestart = true;\n                break;\n        }\n\n        if (needRestart) {\n            if (this.hasUpdateListener) {\n                cc.eventManager.removeListener(this.updateListener);\n                this.hasUpdateListener = false;\n            }\n            let searchPaths = jsb.fileUtils.getSearchPaths();\n            let newPaths = this.atManager.getLocalManifest().getSearchPaths();\n            fun.log('hotUpdate', 'success ', newPaths);\n            Array.prototype.unshift(searchPaths, newPaths);\n            searchPaths.unshift(cc.path.join(jsb.fileUtils.getWritablePath(), \"hotUpdate\"));\n            cc.sys.localStorage.setItem('HotUpdateSearchPaths', JSON.stringify(searchPaths));\n            jsb.fileUtils.setSearchPaths(searchPaths);\n            fun.utils.restart();\n        }\n    },\n\n    showError (str) {\n        let data = {\n            contentStr: str,\n            okBtnStr: '重启',\n            hideCloseBtn: true,\n            okCb () {\n                fun.utils.restart();\n            }\n        };\n        fun.event.dispatch('MinSingleButtonPop', data)\n    },\n\n    onDestroy () {\n        if (this.hasCheckListener) {\n            cc.eventManager.removeListener(this.checkListener);\n        }\n        if (this.hasUpdateListener) {\n            cc.eventManager.removeListener(this.updateListener);\n        }\n        if (this.atManager) {\n            this.atManager.release();\n        }\n    },\n});"]}